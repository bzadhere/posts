---
title: 性能之巅 笔记
date: 2018-10-24 15:46:01
tags:
categories: 读书笔记
---

# 第一章 绪论

系统性能上对整个系统的研究，包括了所有硬件组件和整个软件栈。
所有数据路径上和软硬件上发生的事情都包括在内，因为这些可能都影响性能。

性能领域包括以下事情：
	1. 设置性能目标和建立性能模型
	2. 基于软件或硬件原型进行性能特征归纳
	3. 对开发的代码进行性能测试(软件整合之前)
	4. 执行软件的非回归性测试(软件发布前或发布后)
	5. 针对软件发布的基准测试
	6. 目标环境中的概念验证测试
	7. 生产环境的部署的配置优化
	8. 监控生产环境中运行的软件
	9. 特定问题的性能分析
	
术语容量规划是指一系列事前行动。在计划阶段，通过研究开发软件的资源占用情况，
来得知原有设计在多大程度上能满足目标需求。在部署后，这样的问题在出现之前就
能被预测。

性能分析必须量化问题的重要程度， 有一个指标非常合适，延时。

动态跟踪技术把所有的软件变得可以监控，而且能用在真实的生产环境中。
这项技术利用内存中的CPU指令并在这些指令上动态构建检测数据。这样能从任何
运行的软件中获得定制化的性能统计数据，从而提供了远超系统的自带的统计所能给予的观测性。

DTrace对用户态和内核态的软件都提供了静态跟踪和动态跟踪，并且数据是实时产生的。

---------------------------------------------------------------------------------------

# 第二章 方法

术语：
IOPS：每秒输入/输出的操作次数，是数据传输的一个度量方法。对于磁盘，就是每秒读和写的次数。
吞吐量：数据传输或操作的速度
响应时间：一次操作完成的时间
延时: 操作里用来等待服务的时间
使用率：对于服务所请求的资源，描述在给定的时间区间内资源的繁忙程度
饱和度: 某一资源无法满足服务的排队工作量
/瓶颈/工作负载/缓存


模型：
----------------------------------------------------------------------------------------

# 第三章 操作系统

了解操作系统和内核对于系统性能分析是至关重要的。会经常需要针对系统行为的开发和测试，
如系统调用是如何执行的、CPU是如何调度线程的、有限大小的内存是如何影响性能的、或者文件
系统是如何处理I/O的。

基本概念介绍，最好结合《深入理解计算机系统》：

内核：内核的执行/时钟/内核态
栈：用户栈和内核栈; 用函数和寄存器的方式记录了线程的执行历史
中断和中断线程
进程：进程的创建、进程的生命周期、进程环境
系统调用
虚拟内存
内存管理
调度器
文件系统：VFS、I/O栈
缓存（括号内为例子）：应用程序缓存、服务器缓存(apache缓存)、缓存服务器(redis)、数据库缓存(mysql缓冲区高速缓存)、
					目录缓存(DNLC)、文件元数据缓存(inode 缓存)、 操作系统缓存区高速缓存(segvn)、文件系统主缓存(ZFS ARC)
					文件系统次缓存(ZFS L2ARC)、设备缓存(ZFS vdev)、 块缓存(缓冲区高速缓存)、磁盘控制器缓存(RAID卡缓存)
					存储阵列缓存、磁盘内置缓存
网络
设备驱动
多处理器：CPU交叉调用
抢占
资源管理
观测性

----------------------------------------------------------------------------------------

# 第四章 观测工具

工具可以按照系统级别和进程级别来分类，多数工具要么基于计数器要么基于跟踪。

			系统级
              |
 vmstat/iostat|
 mpstat/sar   |  dtrace/tcpdump
              |
计数器-------------------跟踪
       pmap   |
       ps     |  gdb/strace
       top    |
			进程级 

计数器：
	内核维护了各种统计数据，称为计数器，用于对事件的计数。通常计数器实现为无符号整形，发生事件时递增。

系统级别的计数器：
	vmstat: 虚拟内存和物理内存的统计
	mpstat: 每个CPU的使用情况
	iostat: 每个磁盘 I/O 的使用情况，由块设备接口报告
	netstat: 网络接口统计
	sar: 各种各样统计，能归档历史数据
	iftop: 用来监控网卡的实时流量（可以指定网段）、反向解析IP、显示端口信息等
	
进程级别：
	ps：进程状态，显示进程的各种统计信息，包括内存和CPU的使用
	top：按一个统计数据排序，显示排名高的进程
	pmap：将进程的内存和使用统计一起列出
	iotop: 进程的I/O速度
	pidstat：每个进程/线程CPU使用量
	
一般来说，上述工具从/proc 文件系统里读取统计信息。


跟踪：
系统级别：
	tcpdump：网络抓包(libpcap)
	bltrace: 块I/O 跟踪
	dtrace: 跟踪内核的内部活动和所有资源的使用情况，支持静态和动态跟踪
	perf: linux 性能事件，跟踪静态和动态的指针
	
进程级别：
	strace: 系统调用跟踪
	gdb: 调式源码



网络工具：
	nethogs: 按进程查看流量占用
	iptraf: 按连接/端口查看流量
	ifstat: 按设备查看流量
	ethtool: 诊断工具
	tcpdump: 抓包工具
	ss: 连接查看工具, 比netstat更快速更高效
	
	其他: dstat, slurm, nload, bmon
	
----------------------------------------------------------------------------------------
	
# 第五章 应用程序

性能调整离执行的地方越近越好：最好在应用程序里，包括web服务器、
应用服务器、负载均衡、文件服务器等等

设立性能目标能为你的性能分析工作指明方向，并帮助你选择要做的事情。
没有目标，性能分析容易沦为随机的[钓鱼探险]。常见目标：
	延时
	吞吐量
	资源使用率
	
应用程序性能技术：选择I/O尺寸、缓存、缓冲区、轮询、并发和并行、非阻塞I/O、处理器绑定

编程语言相关：编译器优化、解释语言一般不是首选、虚拟机、垃圾回收


----------------------------------------------------------------------------------------

# 第六章 CPU

----------------------------------------------------------------------------------------
# 第七章 内存

背景：内存相关术语
架构：内存软硬件架构
方法：内存分析的方法
分析：分析内存性能工具
调优：性能调优和可调参数范例

1.背景
主存：物理内存，高速数据存储区域，动态随机访问内存(DRAM)
虚拟内存: 一个抽象的主存概念，无限和非竞争性，虚拟内存不是真实的内存
常驻内存：当前处于主存中的内存
匿名内存: 无文件系统位置或者路径名的内存。包括进程地址空间的工作数据，称作堆。
地址空间：内存上下文。每个进程和内核都有对应的虚拟内存空间
段：标记为特殊用途的一块内存区域，例如用来存储可执行或者可写的页
OOM：内存耗尽，内核检测到可用内存低
页：操作系统和CPU使用的内存单位。一直以来都是4KB或8KB，现代处理器允许多种页大小。
缺页：无效内存。使用按虚拟内存，这是正常事件。
交换：将整个进程从主存转移到交换设备。
交换(空间)：存放换页的匿名数据和交换进程的磁盘空间。可以是存储设备的一块空间，
			也称为物理交换设备，或者是文件系统，称作交换文件。
			

换页：页面换入和调出主存。包含文件系统换页(mmap), 匿名换页(进程堆和栈)

按需换页：将虚拟内存映射到物理内存。CPU创建映射的开销延迟到实际需要或者访问。
		  
过度换页：支持按需换页操作系统，malloc可以申请大于物理内存和交换设备的总和。
		  
文件系统缓占用：应用进程需要时会释放

2.架构
硬件：主存，总线，CPU缓存，MMU(内存管理单元)
软件：

3.方法



----------------------------------------------------------------------------------------
# 第八章 文件系统

----------------------------------------------------------------------------------------
# 第九章 磁盘

----------------------------------------------------------------------------------------
# 第十章 网络

----------------------------------------------------------------------------------------

