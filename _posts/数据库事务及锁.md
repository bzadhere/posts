---
title: 数据库事务及锁
date: 2018-10-23 19:00:26
tags: ACID
categories: 数据库
---

# 事务的四个特性
> * 原子性(Atomicity)
> * 一致性(Consistency)
> * 隔离性(Isolation)
> * 持久性(Durability)

<!-- more -->


- 原子性  
一个事务中的全部操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。
事务在执行过程中发生错误，会回滚到事务开始前的状态，不会对数据库有任何影响。

- 一致性
在事务开始之前和事务结束以后，数据库的完整性没有被破坏。  
拿转账来说，假设用户A和用户B两者的钱加起来一共是5000，那么不管A和B之间如何转账，
转几次账，事务结束后两个用户的钱相加起来应该还得是5000，这就是事务的一致性。

- 隔离性
数据库允许多个并发事务对数据进行读写和修改，防止多个事务并发执行时由于交叉执行而导致数  
据的不一致。事务隔离分为不同级别，包括读未提交(Read uncommitted)、读提交(read committed)、  
可重复读(repeatable read)和串行化（Serializable）。  
即要达到这么一种效果：对于任意两个并发的事务T1和T2，在事务T1看来，T2要么在T1开始之前就已经  
结束，要么在T1结束之后才开始，这样每个事务都感觉不到有其他事务在并发地执行。

- 持久性
事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。

# 事务隔离级别
如果不考虑事务的隔离性，会发生的几种问题:
1. 脏读是指在一个事务处理过程里读取了另一个未提交的事务中的数据。(读未提交)

2. 不可重复读是指在对于数据库中的某个数据，一个事务范围内多次查询却返回了  
不同的数据值，这是由于在查询间隔，被另一个事务修改并提交了。  
不可重复读和脏读的区别是，脏读是某一事务读取了另一个事务未提交的脏数据，而不  
可重复读则是读取了前一事务提交的数据。

3. 虚读(幻读)
幻读是事务非独立执行时发生的一种现象。例如事务T1对一个表中所有的行的某个数据项做  
了从“1”修改为“2”的操作，这时事务T2又对这个表中插入了一行数据项，而这个数据项的数值  
还是为“1”并且提交给数据库。而操作事务T1的用户, 如果再查看刚刚修改的数据，会发现还  
有一行没有修改，其实这行是从事务T2中添加的，就好像产生幻觉一样，这就是发生了幻读。
幻读和不可重复读都是读取了另一条已经提交的事务(这点就脏读不同)，所不同的是不可重复  
读查询的都是同一个数据项，而幻读针对的是一批数据整体(比如数据的个数)。

4. 串行化(Serializable)
    在串行化隔离模式下，消除了脏读，幻象，但事务并发度急剧下降，事务的隔离级别与事务的并发度成  
    反比，隔离级别越高，事务的并发度越低。实际生产环境下，dba会在并发和满足业务需求之间作权衡，  
    选择合适的隔离级别  

  MySQL数据库为我们提供的四种隔离级别：
  	1）Read uncommitted (读未提交)：最低级别，任何情况都无法保证
  	2）Read committed (读已提交)：可避免脏读的发生
  	3）Repeatable read (可重复读)：可避免脏读、不可重复读的发生
  	4）Serializable (串行化)：可避免脏读、不可重复读、幻读的发生

在MySQL数据库中，支持上面四种隔离级别，默认的为Repeatable read (可重复读)；而在Oracle数据库中，
只支持Serializable (串行化)级别和Read committed (读已提交)这两种级别，其中默认的为Read committed级别

# 事务隔离的实现——锁
1. 共享锁(S锁)
> [] 用于只读操作(SELECT)，锁定共享的资源。共享锁不会阻止其他用户读，但是阻止其他的用户写和修改。
2. 更新锁(U锁)
> [] 用于可更新的资源中。防止当多个会话在读取、锁定以及随后可能进行的资源更新时发生常见形式的死锁。
3. 独占锁(X锁，也叫排他锁)
> [] 一次只能有一个独占锁用在一个资源上，并且阻止其他所有的锁包括共享缩。写是独占锁，可以有效的防止“脏读”。

Read Uncommited 如果一个事务已经开始写数据，则另外一个数据则不允许同时进行写操作，但允许其他事务读此行数据。该隔离级别可以通过“排他写锁”实现。

Read Committed 读取数据的事务允许其他事务继续访问该行数据，但是未提交的写事务将会禁止其他事务访问该行。可以通过“瞬间共享读锁”和“排他写锁”实现。

Repeatable Read 读取数据的事务将会禁止写事务（但允许读事务），写事务则禁止任何其他事务。可以通过“共享读锁”和“排他写锁”实现。

Serializable 读加共享锁，写加排他锁，读写互斥。

# 三级封锁协议

# mvcc多版本并发控制协议

# 间隙锁





# SQL 优化

[优化策略](https://mp.weixin.qq.com/s/YqyHA_CuIpk5My3Ggu2Fgg)

[内核简介](https://mp.weixin.qq.com/s/q9wSQJu0MBmVN97KIdX8aA)